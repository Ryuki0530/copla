<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="./css/stylesheet2.css">
    <meta charset="utf-8">
    <title></title>
</head>
<body bgcolor="white">
<div class="top">
    <div class="search">
        <input type="search" id="site-search" name="q"/>
        <button type="submit" class="bt-sch"><img src=".././resource/検索.png" width="15"></button>
    </div>
</div>
<div id="postsContainer">
    <!-- ここに投稿内容が表示されます -->
</div>
<div id="popupForm" class="popup-form">
    <div class="popup-form-content">
        <span id="closeFormButton" class="close">&times;</span>
        <form id="postForm"> 
            <textarea id="comment" class="commentTextArea" name="comment" style="width: 100%; box-sizing: border-box; font-size: 200%" maxlength="300"></textarea>
            <br><br>
            <label for="category">投稿カテゴリーを選択:</label>
            <select id="category" name="category" style="font-size: 140%">
                <option value="2">授業</option>
                <option value="3">部活</option>
                <option value="4">研究室</option>
                <option value="5">就活</option>
                <option value="1">その他</option>
                <option value="6">イベント</option>
            </select><br>
            <input class="submitButton" type="submit" value="投稿" name="submitButton" style="font-size: 140%">
        </form>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="../scripts/postPop.js"></script>
<script>
    let offset = 0;
    const limit = 20;
    const postsContainer = document.getElementById('postsContainer');
    let isLoading = false;

    async function likePost(postID) {
        try {
            let response = await $.ajax({
                url: "../../apk/likePost.php",
                type: "POST",
                data: { postID: postID }
            });
            console.log(response);
            offset = 0;
            getPosts(true);
        } catch (error) {
            console.error("Error liking post:", error);
        }
    }

    async function likeReply(replyID) {
        try {
            let response = await $.ajax({
                url: "../../apk/likeReply.php",
                type: "POST",
                data: { repID: replyID }
            });
            console.log(response);
            offset = 0;
            getPosts(true);
        } catch (error) {
            console.error("Error liking reply:", error);
        }
    }

    function getPosts(initialLoad = false) {
        if (isLoading) return;
        isLoading = true;
        $.ajax({
            url: "../../apk/getPosts.php",
            type: "GET",
            data: { offset: offset, limit: limit },
            success: function (response) {
                if (initialLoad) {
                    postsContainer.innerHTML = response;
                } else {
                    postsContainer.innerHTML += response;
                }
                offset += limit;
                isLoading = false;
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error("Error getting posts:", textStatus, errorThrown);
                isLoading = false;
            }
        });
    }

    $(document).ready(function () {
        getPosts(true); // 初回読み込み

        $(window).scroll(function() {
            if ($(window).scrollTop() + $(window).height() >= $(document).height() - 10) {
                getPosts();
            }
        });

        $("#postForm").submit(function (event) {
            event.preventDefault(); // デフォルトのフォーム送信をキャンセル

            $.ajax({
                url: "../../apk/makePost.php",
                type: "POST",
                data: $(this).serialize(),
                success: function (response) {
                    $("#comment").val("");
                    popupForm.style.display = 'none';
                    offset = 0; // オフセットをリセット
                    getPosts(true); // 投稿後に最新の投稿を再読み込み
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error("Error making post:", textStatus, errorThrown);
                }
            });
        });

        $(document).on('submit', '.replyForm', function (event) {
            event.preventDefault();
            var postID = $(this).data('post-id');
            var formData = $(this).serialize() + '&postID=' + postID;
            $.ajax({
                url: "../../apk/makeReply.php",
                type: "POST",
                data: formData,
                success: function (response) {
                    getPosts(true);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error("Error making reply:", textStatus, errorThrown);
                }
            });
        });

        $(document).on('click', '.likePostButton', function (event) {
            event.preventDefault();
            var postID = $(this).data('post-id');
            likePost(postID);
        });

        $(document).on('click', '.likeReplyButton', function (event) {
            event.preventDefault();
            var replyID = $(this).data('reply-id');
            likeReply(replyID);
        });
    });
</script>
</body>
</html>
