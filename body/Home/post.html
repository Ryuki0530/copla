<script>
    const urlParams = new URLSearchParams(window.location.search);
    const postID = urlParams.get('iD');
</script>

<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="./css/stylesheet2.css">
    <meta charset="utf-8">
    <title></title>
</head>
<body bgcolor="white">

<div id="postsContainer">
    <!-- ここに投稿内容が表示されます -->
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="../scripts/postPop.js"></script>
<script>
    let offset = 0;
    const limit = 20;
    const postsContainer = document.getElementById('postsContainer');
    let isLoading = false;

    function showHideFormElement() {
        var category = document.getElementById("category");
        var titleForm = document.getElementById("titleForm");
        var comment = document.getElementById("comment");

        if (category.value == "7") {
            titleForm.style.display = "block";
            comment.style.height = "500px";
        } else {
            titleForm.style.display = "none";
            comment.style.height = "200px";
        }
    }

    async function likePost(postID) {
        try {
            let response = await $.ajax({
                url: "../../apk/likePost.php",
                type: "POST",
                data: { postID: postID }
            });
            console.log(response);
            offset = 0;
            getPosts(true);
        } catch (error) {
            console.error("Error liking post:", error);
        }
    }

    async function likeReply(replyID) {
        try {
            let response = await $.ajax({
                url: "../../apk/likeReply.php",
                type: "POST",
                data: { repID: replyID }
            });
            console.log(response);
            offset = 0;
            getPosts(true);
        } catch (error) {
            console.error("Error liking reply:", error);
        }
    }

    function getPosts(initialLoad = false) {
        if (isLoading) return;
        isLoading = true;
        $.ajax({
            url: "../../apk/singlePost.php",
            type: "GET",
            data: { iD: postID },
            success: function (response) {
                if (initialLoad) {
                    postsContainer.innerHTML = response;
                } else {
                    postsContainer.innerHTML += response;
                }
                offset += limit;
                isLoading = false;
            },
            error: function (jqXHR, textStatus, errorThrown) {
                console.error("Error getting posts:", textStatus, errorThrown);
                isLoading = false;
            }
        });
    }


    $(document).ready(function () {
        getPosts(true); // 初回読み込み

      

        $("#postForm").submit(function (event) {
            event.preventDefault(); // デフォルトのフォーム送信をキャンセル

            var formData = new FormData(this);

            $.ajax({
                url: "../../apk/makePost.php",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                dataType: "json",
                success: function (response) {
                    if (response.error) {
                        alert(response.error);
                    } else {
                        $("#comment").val("");
                        popupForm.style.display = 'none';
                        offset = 0; // オフセットをリセット
                        getPosts(true); // 投稿後に最新の投稿を再読み込み
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error("Error making post:", textStatus, errorThrown);
                }
            });
        });


        $(document).on('submit', '.replyForm', function (event) {
            event.preventDefault();
            var postID = $(this).data('post-id');
            var formData = $(this).serialize() + '&postID=' + postID;
            $.ajax({
                url: "../../apk/makeReply.php",
                type: "POST",
                data: formData,
                success: function (response) {
                    offset = 0; // オフセットをリセット
                    getPosts(true); // 返信後に最新の投稿を再読み込み
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error("Error making reply:", textStatus, errorThrown);
                }
            });
        });

        $(document).on('click', '.likePostButton', function (event) {
            event.preventDefault();
            var postID = $(this).data('post-id');
            likePost(postID);
        });

        $(document).on('click', '.likeReplyButton', function (event) {
            event.preventDefault();
            var replyID = $(this).data('reply-id');
            likeReply(replyID);
        });

        $(document).on('click', '.moreReplyButton', function (event) {
            event.preventDefault();
            var openID = $(this).data('post-id');
            console.log(openID);
            openReply(openID);
        });

        $("#searchForm").submit(function (event) {
            event.preventDefault(); // デフォルトのフォーム送信をキャンセル
            const keyword = $("#site-search").val();
            searchPosts(keyword); // キーワード検索を実行
        });
    });
</script>

</body>
</html>
